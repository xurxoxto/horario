<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CEIP Outes — 3º Ciclo Schedule</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #5A67D8; 
      --secondary: #F4F5F7; 
      --background: #F8F9FE; 
      --text: #4A5568; 
      --heading: #2D3748; 
      --card-bg: #ffffff; 
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
      --border: #E2E8F0; 
      --input-bg: #fff;
    }
    body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--text); padding-bottom: 3rem; }
    
    /* Login Page Styles */
    #login-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--background);
      display: none; /* Hidden until JS confirms user is logged out */
      justify-content: center; align-items: center; z-index: 2000;
    }
    .login-card {
      background-color: var(--card-bg); padding: 2.5rem; border-radius: .75rem;
      box-shadow: var(--card-shadow); width: 100%; max-width: 400px; border: 1px solid var(--border);
    }
    #login-error { display: none; }

    .navbar { background: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .card { border: 1px solid var(--border); border-radius: .75rem; box-shadow: var(--card-shadow); background: var(--card-bg); }
    .card-header { background-color: var(--secondary); border-bottom: 1px solid var(--border); color: var(--heading); font-weight: 600; }
    .accordion-button { background: var(--primary) !important; color: white !important; }
    .accordion-button:not(.collapsed), .accordion-button:focus { box-shadow: none; }
    .accordion-button::after { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708 .708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e"); }
    .table { border-color: var(--border); table-layout: fixed; }
    .table thead th { 
        text-align: center; 
        vertical-align: middle; 
        font-size: 0.85rem;
        padding: 0.5rem;
    }
    .table-light { --bs-table-bg: var(--secondary); --bs-table-border-color: var(--border); color: var(--heading); }
    .time-slot { background-color: var(--secondary); font-weight: 600; color: var(--heading); vertical-align: middle; text-align: center; font-size: 0.85rem; }
    #scheduleBody td { position: relative; vertical-align: top; padding: 0.5rem; }
    .add-activity-btn-cell {
        position: absolute; top: 4px; left: 4px; opacity: 0.2;
        transition: opacity 0.2s ease-in-out; padding: 0.1rem 0.45rem;
        line-height: 1; border-radius: 50%; z-index: 10;
    }
    #scheduleBody td:hover .add-activity-btn-cell { opacity: 1; }
    .workshop-cell { touch-action: none; cursor: grab; border-radius: .375rem; padding: .55rem; margin-bottom: .5rem; transition: transform .18s ease, box-shadow .18s ease; position: relative; font-size: .9rem; box-shadow: 0 3px 8px rgba(0,0,0,0.06); color: var(--heading); }
    .workshop-cell:hover { transform: translateY(-4px); box-shadow: 0 8px 22px rgba(0,0,0,0.12); }
    .workshop-cell small { color: var(--text); }
    .workshop-cell .detail-subject { font-weight: 600; }
    .workshop-cell .detail-space { font-style: italic; }
    .workshop-cell .badge { white-space: normal; text-align: left; display: inline-block; width: 100%; }
    .comment-icon { position: absolute; top: .45rem; right: .45rem; font-size: .85rem; opacity: .85; }
    .workshops-container { min-height: 80px; }
    .drag-over { background-color: rgba(90, 103, 216, 0.1); border: 2px dashed var(--primary); }
    .form-control, .form-select { background: var(--input-bg); border-color: var(--border); color: var(--text); }
    .form-control:focus, .form-select:focus { background: var(--input-bg); color: var(--text); border-color: var(--primary); box-shadow: 0 0 0 2px rgba(90,103,216,.25); }
    select[multiple] { height: 120px; }
    .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }
    .list-group-item { background-color: transparent; border-color: var(--border); padding: .4rem 1rem; }
    .modal-content { background: var(--card-bg); }
    .modal-body { max-height: 70vh; overflow-y: auto; }
    .subject-card-body { color: #2D3748; font-weight: 500; }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-card text-center">
        <i class="fas fa-school fa-2x text-primary mb-3"></i>
        <h2 class="h4 mb-1 fw-bold">Schedule Access</h2>
        <p class="text-muted mb-4">Please sign in to continue</p>
        <form id="login-form">
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" placeholder="Email" required>
                <label for="email">Email</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" placeholder="Password" required>
                <label for="password">Password</label>
            </div>
            <button type="submit" class="btn btn-primary w-100 py-2">Sign In</button>
            <p id="login-error" class="text-danger mt-3 mb-0">Invalid email or password.</p>
        </form>
    </div>
  </div>

  <div id="app-wrapper" style="display: none;">
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <i class="fas fa-school me-2"></i><span>CEIP Outes — 3º Ciclo</span>
        </a>
        <button id="sign-out-btn" class="btn btn-outline-light btn-sm ms-auto">Sign Out</button>
      </div>
    </nav>
  
    <div class="container" id="app-container">
      <div class="accordion mb-4" id="configAccordion">
        <div class="accordion-item card">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig">
              <h5 class="m-0"><i class="fas fa-cog me-2"></i>Configuration Panel</h5>
            </button>
          </h2>
          <div id="collapseConfig" class="accordion-collapse collapse" data-bs-parent="#configAccordion">
            <div class="card-body">
              <div class="row" id="configManagementRow">
                <div class="col-md-6 col-lg-3 mb-4">
                  <label class="form-label fw-bold">Teachers</label>
                  <ul class="list-group mb-2" id="teacherList"></ul>
                  <div class="input-group"><input type="text" class="form-control" placeholder="New Teacher" id="newTeacher"><button class="btn btn-success" id="addTeacherBtn"><i class="fas fa-plus"></i></button></div>
                </div>
                <div class="col-md-6 col-lg-3 mb-4">
                  <label class="form-label fw-bold">Spaces</label>
                  <ul class="list-group mb-2" id="spaceList"></ul>
                  <div class="input-group"><input type="text" class="form-control" placeholder="New Space" id="newSpace"><button class="btn btn-success" id="addSpaceBtn"><i class="fas fa-plus"></i></button></div>
                </div>
                <div class="col-md-6 col-lg-3 mb-4">
                  <label class="form-label fw-bold">Courses</label>
                  <ul class="list-group mb-2" id="courseList"></ul>
                  <div class="input-group"><input type="text" class="form-control" placeholder="New Course" id="newCourse"><button class="btn btn-success" id="addCourseBtn"><i class="fas fa-plus"></i></button></div>
                </div>
                <div class="col-md-6 col-lg-3 mb-4">
                  <label class="form-label fw-bold">Time Slots</label>
                  <div id="timeSlotList"></div>
                  <div class="input-group mt-2"><input type="text" class="form-control" placeholder="e.g., 08:00-09:30" id="newTimeSlot"><button class="btn btn-success" id="addTimeSlotBtn"><i class="fas fa-plus"></i></button></div>
                </div>
              </div>
              <hr>
              <div class="row mt-3" id="subjectManagementRow">
                <div class="col-12">
                  <label class="form-label fw-bold">Subjects</label>
                  <ul class="list-group mb-2" id="subjectList"></ul>
                  <div class="input-group mt-2">
                    <input type="text" class="form-control" placeholder="New Subject Name" id="newSubjectName">
                    <input type="color" class="form-control form-control-color" id="newSubjectColor" value="#5E72E4" title="Choose color">
                    <button class="btn btn-success" id="addSubjectBtn">Add Subject</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-header py-3 d-flex flex-wrap justify-content-between align-items-center">
              <h5 class="m-0"><i class="fas fa-calendar-alt me-2"></i>Weekly Schedule</h5>
              <div class="btn-toolbar">
                <div class="btn-group me-2 mb-2 mb-md-0">
                  <button class="btn btn-sm btn-outline-secondary" id="exportCsvBtn"><i class="fas fa-file-csv me-1"></i> CSV</button>
                  <button class="btn btn-sm btn-outline-danger" id="exportPdfBtn"><i class="fas fa-file-pdf me-1"></i> PDF</button>
                </div>
                <div class="btn-group me-2 mb-2 mb-md-0">
                  <button class="btn btn-sm btn-info text-white" id="archiveWeekBtn"><i class="fas fa-archive me-1"></i> Archive</button>
                  <button class="btn btn-sm btn-danger" id="clearScheduleBtn"><i class="fas fa-broom me-1"></i> Clear</button>
                </div>
                <div class="btn-group mb-2 mb-md-0">
                  <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newWorkshopModal"><i class="fas fa-plus me-1"></i> New Activity</button>
                </div>
              </div>
            </div>
            <div class="card-body border-bottom">
              <div class="row align-items-end">
                <div class="col-md-6 col-lg-2 mb-2">
                  <label for="filterSubject" class="form-label fw-bold"><i class="fas fa-palette me-1"></i>Subject</label>
                  <select id="filterSubject" class="form-select form-select-sm"></select>
                </div>
                <div class="col-md-6 col-lg-2 mb-2">
                  <label for="filterTeacher" class="form-label fw-bold"><i class="fas fa-chalkboard-teacher me-1"></i>Teacher</label>
                  <select id="filterTeacher" class="form-select form-select-sm"></select>
                </div>
                <div class="col-md-6 col-lg-2 mb-2">
                  <label for="filterSpace" class="form-label fw-bold"><i class="fas fa-map-marker-alt me-1"></i>Space</label>
                  <select id="filterSpace" class="form-select form-select-sm"></select>
                </div>
                <div class="col-md-6 col-lg-2 mb-2">
                  <label for="filterCourse" class="form-label fw-bold"><i class="fas fa-users me-1"></i>Course</label>
                  <select id="filterCourse" class="form-select form-select-sm"></select>
                </div>
                <div class="col-md-6 col-lg-2 mb-2">
                    <label for="filterActivityType" class="form-label fw-bold"><i class="fas fa-star me-1"></i>Type</label>
                    <select id="filterActivityType" class="form-select form-select-sm">
                        <option value="all">All Types</option>
                        <option value="ambiente">Ambiente Only</option>
                        <option value="regular">Regular Only</option>
                    </select>
                </div>
                <div class="col-md-6 col-lg-2 mb-2">
                  <button class="btn btn-sm btn-secondary w-100 mt-3" id="clearFiltersBtn"><i class="fas fa-times me-2"></i>Clear</button>
                </div>
              </div>
            </div>
            <div class="card-body p-2 p-md-3">
              <div class="table-responsive">
                <table class="table table-bordered" id="scheduleTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width:12%">Time</th>
                      <th class="text-center">Monday</th>
                      <th class="text-center">Tuesday</th>
                      <th class="text-center">Wednesday</th>
                      <th class="text-center">Thursday</th>
                      <th class="text-center">Friday</th>
                    </tr>
                  </thead>
                  <tbody id="scheduleBody" class="align-middle"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="m-0"><i class="fas fa-history me-2"></i>Schedule History</h5>
              <button class="btn btn-sm btn-outline-danger" id="clearHistoryBtn">
                <i class="fas fa-trash-alt me-1"></i> Clear All
              </button>
            </div>
            <div class="card-body">
              <div class="accordion" id="historyAccordion"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>
  <div class="modal fade" id="workshopModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Edit Activity</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="editWorkshopId">
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" role="switch" id="isOpenRoomEdit">
            <label class="form-check-label" for="isOpenRoomEdit">Ambiente</label>
          </div>
          <div id="workshopFieldsEdit">
            <div class="mb-3"><label for="editWorkshopName" class="form-label">Workshop Name</label><input type="text" class="form-control" id="editWorkshopName"></div>
          </div>
           <div class="mb-3"><label for="editWorkshopCourse" class="form-label">Course(s) (optional)</label><select class="form-select" id="editWorkshopCourse" multiple></select></div>
           <div class="mb-3"><label for="editWorkshopSubject" class="form-label">Subject(s)</label><select class="form-select" id="editWorkshopSubject" multiple></select></div>
          <div class="mb-3"><label for="editWorkshopTeachers" class="form-label">Teacher(s)/Supervisor(s)</label><select class="form-select" id="editWorkshopTeachers" multiple></select></div>
          <div class="mb-3"><label for="editWorkshopSpaces" class="form-label">Space(s)</label><select class="form-select" id="editWorkshopSpaces" multiple></select></div>
          <div class="row">
            <div class="col-6"><label for="editWorkshopDay" class="form-label">Day</label><select class="form-select" id="editWorkshopDay"></select></div>
            <div class="col-6"><label for="editWorkshopTimeSlot" class="form-label">Time Slot</label><select class="form-select" id="editWorkshopTimeSlot"></select></div>
          </div>
          <div class="mb-3"><label for="editWorkshopComments" class="form-label">Comments (optional)</label><textarea class="form-control" id="editWorkshopComments" rows="2"></textarea></div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" id="duplicateWorkshopBtn" class="btn btn-outline-secondary">Duplicate</button>
          <div>
            <button type="button" id="deleteWorkshopBtn" class="btn btn-danger">Delete</button>
            <button type="button" id="saveWorkshopChangesBtn" class="btn btn-primary">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="newWorkshopModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">New Activity</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="newWorkshopForm">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" role="switch" id="isOpenRoomNew">
              <label class="form-check-label" for="isOpenRoomNew">Ambiente</label>
            </div>
            <div id="workshopFieldsNew">
              <div class="mb-3"><label for="newWorkshopName" class="form-label">Workshop Name</label><input type="text" class="form-control" id="newWorkshopName" placeholder="e.g., Robotics Club"></div>
            </div>
            <div class="mb-3"><label for="newWorkshopCourse" class="form-label">Course(s) (optional)</label><select class="form-select" id="newWorkshopCourse" multiple></select></div>
            <div class="mb-3"><label for="newWorkshopSubject" class="form-label">Subject(s)</label><select class="form-select" id="newWorkshopSubject" multiple></select></div>
            <div class="mb-3"><label for="newWorkshopTeachers" class="form-label">Teacher(s)/Supervisor(s)</label><select class="form-select" id="newWorkshopTeachers" multiple></select></div>
            <div class="mb-3"><label for="newWorkshopSpaces" class="form-label">Space(s)</label><select class="form-select" id="newWorkshopSpaces" multiple></select></div>
            <div class="row">
              <div class="col-6"><label for="newWorkshopDay" class="form-label">Day</label><select class="form-select" id="newWorkshopDay"></select></div>
              <div class="col-6"><label for="newWorkshopTimeSlot" class="form-label">Time Slot</label><select class="form-select" id="newWorkshopTimeSlot"></select></div>
            </div>
            <div class="mb-3"><label for="newWorkshopComments" class="form-label">Comments (optional)</label><textarea class="form-control" id="newWorkshopComments" rows="2"></textarea></div>
          </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button id="createWorkshopBtn" type="button" class="btn btn-primary">Create</button></div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title">Confirm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmationModalBody">Are you sure?</div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmActionBtn" class="btn btn-danger">Confirm</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyD9ddZuPvVHwv6PhD6GMhGOClawzOh9PJQ",
      authDomain: "ceipoutesterceirociclo.firebaseapp.com",
      databaseURL: "https://ceipoutesterceirociclo-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ceipoutesterceirociclo",
      storageBucket: "ceipoutesterceirociclo.appspot.com",
      messagingSenderId: "159547648936",
      appId: "1:159547648936:web:7b17999e4f21b40753cb9d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
  </script>

  <script>
    // --- LOGIN AND APP INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const loginOverlay = document.getElementById('login-overlay');
        const appWrapper = document.getElementById('app-wrapper');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');

        auth.onAuthStateChanged(user => {
            if (user) {
                loginOverlay.style.display = 'none';
                appWrapper.style.display = 'block';
                initializeAppLogic(user); 
            } else {
                loginOverlay.style.display = 'flex';
                appWrapper.style.display = 'none';
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.style.display = 'none';

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Login failed:", error);
                    loginError.textContent = "Error: " + error.message;
                    loginError.style.display = 'block';
                });
        });
        
        document.getElementById('sign-out-btn').addEventListener('click', () => {
          auth.signOut();
        });
    });

    // --- MAIN APPLICATION LOGIC ---
    function initializeAppLogic(user) {
        let data = {};
        let draggedWorkshopId = null;

        const defaultData = {
            workshops: [],
            teachers: ["Sheila", "Jorge", "Adri", "Alba", "Iván", "Zoraida", "Dani", "Luci", "Susana", "Gemma"],
            spaces: ["A - Language Arts Room", "B - Science Lab", "C - Music Room", "D - Computer Lab", "E - Gymnasium", "F - Covered Courtyard"],
            courses: ["5A", "5B", "5C", "6A", "6B"],
            subjects: [{ name: "Language Arts", color: "#5E72E4" }, { name: "Mathematics", color: "#11CDEF" }, { name: "Social Studies", color: "#F5365C" }, { name: "Natural Sciences", color: "#FB6340" }, { name: "English", color: "#FFD600" }, { name: "Physical Education", color: "#8965E0" }],
            timeSlots: ["8:00-9:30", "9:30-11:00", "11:30-13:00"],
            days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            history: []
        };

        const dom = {
            scheduleBody: document.getElementById('scheduleBody'),
            toastContainer: document.querySelector('.toast-container'),
            newWorkshopModal: new bootstrap.Modal(document.getElementById('newWorkshopModal')),
            editWorkshopModal: new bootstrap.Modal(document.getElementById('workshopModal')),
            confirmationModal: new bootstrap.Modal(document.getElementById('confirmationModal'))
        };

        let actionToConfirm = null;
        let popoverList = [];

        function debounce(func, wait) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }
        
        const saveDataToFirebase = debounce(() => {
            database.ref('scheduleData').set(data)
                .then(() => { showToast("Status Updated", "Your changes have been saved online.", "info"); })
                .catch(error => { showToast("Sync Error", "Could not save changes online.", "danger"); });
        }, 600);

        function syncWithFirebase() {
            database.ref('scheduleData').on('value', (snapshot) => {
                const firebaseData = snapshot.val();
                data = { ...defaultData, ...firebaseData };
                
                // Data Migration
                if (data.workshops) {
                    data.workshops.forEach(w => {
                        if (w.subject && !Array.isArray(w.subjects)) {
                            w.subjects = [w.subject];
                            delete w.subject;
                        } else if (!w.subjects) {
                            w.subjects = [];
                        }
                    });
                }

                renderAll();
            });
        }

        function renderAll() {
            renderLists();
            updateAllDropdowns();
            renderScheduleGrid();
            renderHistory();
        }

        function renderLists() {
            renderEditableList('teacherList', data.teachers, 'teacher');
            renderEditableList('spaceList', data.spaces, 'space');
            renderEditableList('courseList', data.courses, 'course');
            renderSubjects();
            renderEditableList('timeSlotList', data.timeSlots, 'timeSlot');
        }

        function renderEditableList(containerId, items, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const sortedItems = [...(items || [])].sort();
            container.innerHTML = sortedItems.map((item) =>
                `<li class="list-group-item">
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm" value="${item}" data-original-value="${item}" data-type="${type}">
                        <button class="btn btn-sm btn-outline-primary save-entity"><i class="fas fa-save"></i></button>
                        <button class="btn btn-sm btn-outline-danger delete-entity"><i class="fas fa-times"></i></button>
                    </div>
                </li>`
            ).join('');
        }
        
        function renderSubjects() {
            const container = document.getElementById('subjectList');
            if (!container) return;
            container.innerHTML = (data.subjects || [])
                .filter(s => s.name)
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(subject =>
                    `<li class="list-group-item">
                        <div class="input-group">
                            <input type="text" class="form-control form-control-sm" value="${subject.name}" data-original-value="${subject.name}">
                            <input type="color" class="form-control form-control-color" value="${subject.color}">
                            <button class="btn btn-sm btn-outline-primary save-subject"><i class="fas fa-save"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-subject"><i class="fas fa-times"></i></button>
                        </div>
                    </li>`
                ).join('');
        }
        
        function updateAllDropdowns() {
            const subjectOptions = (data.subjects || []).filter(s => s.name).sort((a,b) => a.name.localeCompare(b.name)).map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            const teacherOptions = (data.teachers || []).sort().map(t => `<option value="${t}">${t}</option>`).join('');
            const spaceOptions = (data.spaces || []).sort().map(s => `<option value="${s}">${s}</option>`).join('');
            const courseOptions = (data.courses || []).sort().map(c => `<option value="${c}">${c}</option>`).join('');
            
            document.querySelectorAll('#newWorkshopSubject, #editWorkshopSubject').forEach(el => el.innerHTML = subjectOptions);
            document.getElementById('filterSubject').innerHTML = '<option value="all">All Subjects</option>' + (data.subjects || []).filter(s => s.name).sort((a,b) => a.name.localeCompare(b.name)).map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            document.querySelectorAll('#newWorkshopTeachers, #editWorkshopTeachers').forEach(el => el.innerHTML = teacherOptions);
            document.getElementById('filterTeacher').innerHTML = '<option value="all">All Teachers</option>' + teacherOptions;
            document.querySelectorAll('#newWorkshopSpaces, #editWorkshopSpaces').forEach(el => el.innerHTML = spaceOptions);
            document.getElementById('filterSpace').innerHTML = '<option value="all">All Spaces</option>' + spaceOptions;
            document.querySelectorAll('#newWorkshopCourse, #editWorkshopCourse').forEach(el => el.innerHTML = courseOptions);
            document.getElementById('filterCourse').innerHTML = '<option value="all">All Courses</option>' + courseOptions;
            const dayOptions = (data.days || []).map(day => `<option value="${day}">${day}</option>`).join('');
            document.querySelectorAll('#newWorkshopDay, #editWorkshopDay').forEach(el => el.innerHTML = dayOptions);
            const timeSlotOptions = (data.timeSlots || []).map((ts, i) => `<option value="${i}">${ts}</option>`).join('');
            document.querySelectorAll('#newWorkshopTimeSlot, #editWorkshopTimeSlot').forEach(el => el.innerHTML = timeSlotOptions);
        }

        function getWorkshopBackground(workshopSubjects) {
            if (!workshopSubjects || workshopSubjects.length === 0) return '#6c757d';
            
            const colors = workshopSubjects.map(subjName => {
                const subject = (data.subjects || []).find(s => s.name === subjName);
                return subject ? subject.color : '#6c757d';
            });

            if (colors.length === 1) return colors[0];
            if (colors.length === 2) return `linear-gradient(to right, ${colors[0]} 50%, ${colors[1]} 50%)`;
            
            const stripeSize = 100 / colors.length;
            const gradientStops = colors.map((color, index) => {
                return `${color} ${index * stripeSize}%, ${color} ${(index + 1) * stripeSize}%`;
            }).join(', ');
            return `linear-gradient(to right, ${gradientStops})`;
        }

        function renderScheduleGrid() {
            const filters = {
                subject: document.getElementById('filterSubject').value, teacher: document.getElementById('filterTeacher').value,
                space: document.getElementById('filterSpace').value, course: document.getElementById('filterCourse').value,
                activityType: document.getElementById('filterActivityType').value
            };
            let tableHtml = '';
            (data.timeSlots || []).forEach((timeSlot, timeSlotIndex) => {
                tableHtml += '<tr>';
                tableHtml += `<td class="time-slot">${timeSlot}</td>`;
                (data.days || []).forEach(day => {
                    const workshopsInCell = (data.workshops || [])
                        .filter(w => w.day === day && w.timeSlot === timeSlotIndex)
                        .sort((a, b) => ((a.subjects && a.subjects[0]) || '').localeCompare((b.subjects && b.subjects[0]) || ''));

                    const cellContent = workshopsInCell.filter(workshop => {
                        const subjectMatch = filters.subject === 'all' || (workshop.subjects || []).includes(filters.subject);
                        const teacherMatch = filters.teacher === 'all' || (workshop.teachers || []).includes(filters.teacher);
                        const spaceMatch = filters.space === 'all' || (workshop.spaces || []).includes(filters.space);
                        const courseMatch = filters.course === 'all' || !(workshop.courses && workshop.courses.length > 0) || (workshop.courses || []).some(c => c === filters.course);
                        const typeMatch = filters.activityType === 'all' || (filters.activityType === 'ambiente' && workshop.name === 'Ambiente') || (filters.activityType === 'regular' && workshop.name !== 'Ambiente');
                        return subjectMatch && teacherMatch && spaceMatch && courseMatch && typeMatch;
                    }).map(workshop => {
                        const background = getWorkshopBackground(workshop.subjects);
                        const spaceNames = (workshop.spaces || []).map(s => s.split(' - ')[1] || s).join(', ');
                        let details = [];
                        if (workshop.name !== 'Ambiente' && workshop.subjects && workshop.subjects.length > 0) details.push(`<span class="detail-subject">${workshop.subjects.join(', ')}</span>`);
                        details.push(`<span class="detail-space">${spaceNames}</span>`);
                        if (workshop.courses && workshop.courses.length > 0) details.push(`<em>${workshop.courses.join(', ')}</em>`);
                        const commentIcon = workshop.comments ? `<i class="fas fa-comment comment-icon" data-bs-toggle="popover" data-bs-trigger="hover" title="Comments" data-bs-content="${workshop.comments}"></i>` : '';
                        const teacherBadge = (workshop.teachers || []).length > 0 ? `<br><span class="badge bg-light text-dark mt-1">${workshop.teachers.join(', ')}</span>` : '';
                        return `<div class="workshop-cell" draggable="true" data-id="${workshop.id}" style="background: ${background};">
                                    <strong>${workshop.name}</strong><br><small>${details.join(' &middot; ')}</small>${teacherBadge}${commentIcon}
                                </div>`;
                    }).join('');
                    
                    const addButtonHtml = `<button class="btn btn-sm btn-outline-primary add-activity-btn-cell" data-day="${day}" data-timeslot-index="${timeSlotIndex}" title="Add Activity"><i class="fas fa-plus"></i></button>`;
                    tableHtml += `<td data-day="${day}" data-timeslot-index="${timeSlotIndex}">${addButtonHtml}<div class="workshops-container">${cellContent}</div></td>`;
                });
                tableHtml += '</tr>';
            });
            dom.scheduleBody.innerHTML = tableHtml;
            reinitializePopovers();
        }

        function renderHistory() {
            const accordion = document.getElementById('historyAccordion');
            if (!accordion) return;
            if (!data.history || data.history.length === 0) {
                accordion.innerHTML = '<p class="text-center text-muted">No history recorded yet.</p>'; return;
            }
            accordion.innerHTML = data.history.map((record, index) => {
                const workshopsList = (record.workshops || []).map(w => `<li class="list-group-item">${w.name} (${(w.subjects || []).join(', ')}) - ${(w.teachers || []).join(', ') || 'N/A'}</li>`).join('');
                return `<div class="accordion-item card">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">Archived: ${new Date(record.date).toLocaleString()}</button></h2>
                            <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#historyAccordion">
                                <div class="card-body">
                                    <p><strong>${(record.workshops || []).length} activities</strong> were archived.</p>
                                    <ul class="list-group mb-3">${workshopsList}</ul>
                                    <div class="d-flex justify-content-end gap-2">
                                        <button class="btn btn-sm btn-outline-primary restore-history" data-index="${index}">Restore</button>
                                        <button class="btn btn-sm btn-outline-danger delete-history" data-index="${index}">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            }).join('');
        }

        function reinitializePopovers() {
            popoverList.forEach(p => p.dispose());
            popoverList = [...document.querySelectorAll('[data-bs-toggle="popover"]')].map(el => new bootstrap.Popover(el));
        }
        
        function showToast(title, message, type = 'info') {
            const toastHtml = `<div class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><i class="fas fa-bell me-2"></i><strong class="me-auto">${title}</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body">${message}</div></div>`;
            const toastEl = new DOMParser().parseFromString(toastHtml, 'text/html').body.firstChild;
            dom.toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }
        
        function showConfirmation(message, callback) {
            document.getElementById('confirmationModalBody').textContent = message;
            actionToConfirm = callback;
            dom.confirmationModal.show();
        }

        async function exportToPdf() {
            showToast("Exporting", "Generating PDF, please wait...", "info");
            const { jsPDF } = window.jspdf;
            const scheduleTable = document.getElementById('scheduleTable');
            
            const canvas = await html2canvas(scheduleTable, { 
                scale: 2,
                logging: false,
                useCORS: true,
                width: scheduleTable.scrollWidth,
                height: scheduleTable.scrollHeight,
                windowWidth: scheduleTable.scrollWidth,
                windowHeight: scheduleTable.scrollHeight
            });

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'a4'
            });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;

            const ratio = canvasWidth / canvasHeight;
            
            let imgWidth = pdfWidth - 40; // 20pt margin on each side
            let imgHeight = imgWidth / ratio;

            if (imgHeight > pdfHeight - 40) {
                imgHeight = pdfHeight - 40;
                imgWidth = imgHeight * ratio;
            }
            
            const x = (pdfWidth - imgWidth) / 2;
            const y = (pdfHeight - imgHeight) / 2;

            pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
            pdf.save('schedule.pdf');
        }

        function exportToCsv(filename = 'schedule.csv') {
           if (!data.workshops || data.workshops.length === 0) return showToast('Export Failed', 'Schedule is empty.', 'warning');
            const headers = ['Day', 'Time Slot', 'Activity Name', 'Subjects', 'Courses', 'Teachers', 'Spaces', 'Comments'];
            const rows = data.workshops.map(ws => [ ws.day, data.timeSlots[ws.timeSlot], `"${(ws.name || '')}"`, `"${(ws.subjects || []).join('; ')}"`, `"${(ws.courses || []).join('; ')}"`, `"${(ws.teachers || []).join('; ')}"`, `"${(ws.spaces || []).join('; ')}"`, `"${(ws.comments || '')}"` ].join(','));
            const csv = [headers.join(','), ...rows].join('\n');
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = filename;
            link.click();
        }

        // --- EVENT LISTENERS ---
        
        document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
        document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);

        dom.scheduleBody.addEventListener('dragstart', e => {
            if (e.target.classList.contains('workshop-cell')) {
                draggedWorkshopId = parseInt(e.target.dataset.id);
                e.dataTransfer.effectAllowed = 'move';
            }
        });
        dom.scheduleBody.addEventListener('dragover', e => {
            e.preventDefault();
            const targetCell = e.target.closest('td[data-day]');
            if (targetCell) targetCell.classList.add('drag-over');
        });
        dom.scheduleBody.addEventListener('dragleave', e => e.target.closest('td')?.classList.remove('drag-over'));
        dom.scheduleBody.addEventListener('drop', e => {
            e.preventDefault();
            const targetCell = e.target.closest('td[data-day]');
            if (targetCell && draggedWorkshopId != null) {
                targetCell.classList.remove('drag-over');
                const workshop = (data.workshops || []).find(w => w.id === draggedWorkshopId);
                if (workshop) {
                    workshop.day = targetCell.dataset.day;
                    workshop.timeSlot = parseInt(targetCell.dataset.timeslotIndex);
                    saveDataToFirebase();
                }
            }
            draggedWorkshopId = null;
        });

        document.getElementById('isOpenRoomNew').addEventListener('change', (e) => {
            document.getElementById('workshopFieldsNew').style.display = e.target.checked ? 'none' : 'block';
        });
        document.getElementById('isOpenRoomEdit').addEventListener('change', (e) => {
            document.getElementById('workshopFieldsEdit').style.display = e.target.checked ? 'none' : 'block';
        });
        
        document.getElementById('createWorkshopBtn').addEventListener('click', () => {
            const isOpenRoom = document.getElementById('isOpenRoomNew').checked;
            let name;
            const subjects = Array.from(document.getElementById('newWorkshopSubject').selectedOptions).map(opt => opt.value);
            const courses = Array.from(document.getElementById('newWorkshopCourse').selectedOptions).map(opt => opt.value);

            if (isOpenRoom) {
                if (subjects.length === 0) { return alert('At least one subject is required to set the color for an Ambiente.'); }
                name = 'Ambiente';
            } else {
                name = document.getElementById('newWorkshopName').value.trim();
                if (subjects.length === 0) { return alert('At least one subject is required.'); }
                if (!name) { return alert('Workshop Name is required.'); }
            }
            
            if (!data.workshops) data.workshops = [];
            data.workshops.push({
                id: Date.now(), name, subjects, courses,
                day: document.getElementById('newWorkshopDay').value,
                timeSlot: parseInt(document.getElementById('newWorkshopTimeSlot').value),
                comments: document.getElementById('newWorkshopComments').value.trim(),
                teachers: Array.from(document.getElementById('newWorkshopTeachers').selectedOptions).map(opt => opt.value),
                spaces: Array.from(document.getElementById('newWorkshopSpaces').selectedOptions).map(opt => opt.value)
            });
            saveDataToFirebase();
            document.getElementById('newWorkshopForm').reset();
            document.getElementById('isOpenRoomNew').dispatchEvent(new Event('change'));
            dom.newWorkshopModal.hide();
        });

        document.getElementById('saveWorkshopChangesBtn').addEventListener('click', () => {
            const workshopId = parseInt(document.getElementById('editWorkshopId').value);
            const workshop = (data.workshops || []).find(w => w.id === workshopId);
            if (workshop) {
                const isOpenRoom = document.getElementById('isOpenRoomEdit').checked;
                workshop.subjects = Array.from(document.getElementById('editWorkshopSubject').selectedOptions).map(opt => opt.value);
                workshop.courses = Array.from(document.getElementById('editWorkshopCourse').selectedOptions).map(opt => opt.value);

                if (isOpenRoom) {
                    if (workshop.subjects.length === 0) { return alert('At least one subject is required to set the color for an Ambiente.'); }
                    workshop.name = 'Ambiente';
                } else {
                    workshop.name = document.getElementById('editWorkshopName').value.trim();
                }
                workshop.day = document.getElementById('editWorkshopDay').value;
                workshop.timeSlot = parseInt(document.getElementById('editWorkshopTimeSlot').value);
                workshop.comments = document.getElementById('editWorkshopComments').value.trim();
                workshop.teachers = Array.from(document.getElementById('editWorkshopTeachers').selectedOptions).map(opt => opt.value);
                workshop.spaces = Array.from(document.getElementById('editWorkshopSpaces').selectedOptions).map(opt => opt.value);
                saveDataToFirebase();
                dom.editWorkshopModal.hide();
            }
        });
        
        dom.scheduleBody.addEventListener('click', e => {
            const addBtn = e.target.closest('.add-activity-btn-cell');
            if(addBtn) {
                const day = addBtn.dataset.day;
                const timeSlotIndex = addBtn.dataset.timeslotIndex;
                document.getElementById('newWorkshopForm').reset();
                const openRoomSwitch = document.getElementById('isOpenRoomNew');
                openRoomSwitch.checked = false;
                openRoomSwitch.dispatchEvent(new Event('change'));
                document.getElementById('newWorkshopDay').value = day;
                document.getElementById('newWorkshopTimeSlot').value = timeSlotIndex;
                dom.newWorkshopModal.show();
                return;
            }

            const cell = e.target.closest('.workshop-cell');
            if (cell) {
                const workshopId = parseInt(cell.dataset.id);
                const workshop = (data.workshops || []).find(w => w.id === workshopId);
                if (workshop) {
                    const isOpenRoom = workshop.name === 'Ambiente';
                    const isOpenRoomCheckbox = document.getElementById('isOpenRoomEdit');
                    isOpenRoomCheckbox.checked = isOpenRoom;
                    isOpenRoomCheckbox.dispatchEvent(new Event('change'));

                    document.getElementById('editWorkshopId').value = workshop.id;
                    document.getElementById('editWorkshopName').value = workshop.name;
                    Array.from(document.getElementById('editWorkshopSubject').options).forEach(opt => {
                        opt.selected = (workshop.subjects || []).includes(opt.value);
                    });
                    Array.from(document.getElementById('editWorkshopCourse').options).forEach(opt => {
                        opt.selected = (workshop.courses || []).includes(opt.value);
                    });
                    document.getElementById('editWorkshopDay').value = workshop.day;
                    document.getElementById('editWorkshopTimeSlot').value = workshop.timeSlot;
                    document.getElementById('editWorkshopComments').value = workshop.comments || '';
                    Array.from(document.getElementById('editWorkshopTeachers').options).forEach(opt => {
                        opt.selected = (workshop.teachers || []).includes(opt.value);
                    });
                    Array.from(document.getElementById('editWorkshopSpaces').options).forEach(opt => {
                        opt.selected = (workshop.spaces || []).includes(opt.value);
                    });
                    dom.editWorkshopModal.show();
                }
            }
        });

        document.getElementById('deleteWorkshopBtn').addEventListener('click', () => {
            const workshopId = parseInt(document.getElementById('editWorkshopId').value);
            showConfirmation('Are you sure you want to delete this activity?', () => {
                data.workshops = (data.workshops || []).filter(w => w.id !== workshopId);
                saveDataToFirebase();
                dom.editWorkshopModal.hide();
            });
        });

        document.getElementById('duplicateWorkshopBtn').addEventListener('click', () => {
            const workshopId = parseInt(document.getElementById('editWorkshopId').value);
            const workshop = (data.workshops || []).find(w => w.id === workshopId);
            if(workshop) {
                const newWorkshop = JSON.parse(JSON.stringify(workshop)); // Deep copy
                newWorkshop.id = Date.now();
                newWorkshop.name = workshop.name;

                data.workshops.push(newWorkshop);
                saveDataToFirebase();
                dom.editWorkshopModal.hide();
                showToast("Activity Duplicated", `A copy of "${newWorkshop.name}" was created.`, "success");
            }
        });
        
        document.getElementById('clearScheduleBtn').addEventListener('click', () => {
            showConfirmation("Are you sure you want to clear the entire schedule?", () => {
                data.workshops = [];
                saveDataToFirebase();
            });
        });

        document.getElementById('archiveWeekBtn').addEventListener('click', () => {
            showConfirmation("Archive this week's schedule? A copy will be saved to history.", () => {
                if ((data.workshops || []).length > 0) {
                    if (!data.history) data.history = [];
                    const workshopsToArchive = JSON.parse(JSON.stringify(data.workshops));
                    data.history.unshift({ date: new Date().toISOString(), workshops: workshopsToArchive });
                    saveDataToFirebase();
                    showToast("Schedule Archived", "A copy has been saved to history.", "success");
                } else {
                    showToast("Archive Failed", "Cannot archive an empty schedule.", "warning");
                }
            });
        });

        document.getElementById('historyAccordion').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const index = parseInt(button.dataset.index);
            if (button.classList.contains('restore-history')) {
                showConfirmation("This will replace your current schedule with the archived one.", () => {
                    data.workshops = data.history[index].workshops;
                    saveDataToFirebase();
                });
            }
            if (button.classList.contains('delete-history')) {
                showConfirmation("Are you sure you want to delete this specific archive?", () => {
                    data.history.splice(index, 1);
                    saveDataToFirebase();
                });
            }
        });
        
        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            showConfirmation("Delete ALL archived history? This cannot be undone.", () => {
                data.history = [];
                saveDataToFirebase();
            });
        });

        ['filterSubject', 'filterTeacher', 'filterSpace', 'filterCourse', 'filterActivityType'].forEach(id => {
            document.getElementById(id).addEventListener('change', renderScheduleGrid);
        });
        
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            ['filterSubject', 'filterTeacher', 'filterSpace', 'filterCourse', 'filterActivityType'].forEach(id => {
                document.getElementById(id).value = 'all';
            });
            renderScheduleGrid();
        });
        
        document.getElementById('confirmActionBtn').addEventListener('click', () => {
            if (actionToConfirm) actionToConfirm();
            actionToConfirm = null;
            dom.confirmationModal.hide();
        });

        document.getElementById('addTeacherBtn').addEventListener('click', () => {
            const input = document.getElementById('newTeacher');
            const name = input.value.trim();
            if (name && !(data.teachers || []).includes(name)) {
                if (!data.teachers) data.teachers = [];
                data.teachers.push(name);
                saveDataToFirebase();
            }
            input.value = '';
        });
        
        document.getElementById('addSpaceBtn').addEventListener('click', () => {
            const input = document.getElementById('newSpace');
            const name = input.value.trim();
            if (name && !(data.spaces || []).includes(name)) {
                if (!data.spaces) data.spaces = [];
                data.spaces.push(name);
                saveDataToFirebase();
            }
            input.value = '';
        });
        
        document.getElementById('addCourseBtn').addEventListener('click', () => {
            const input = document.getElementById('newCourse');
            const name = input.value.trim();
            if (name && !(data.courses || []).includes(name)) {
                if (!data.courses) data.courses = [];
                data.courses.push(name);
                saveDataToFirebase();
            }
            input.value = '';
        });

        document.getElementById('addSubjectBtn').addEventListener('click', () => {
            const nameInput = document.getElementById('newSubjectName');
            const name = nameInput.value.trim();
            const color = document.getElementById('newSubjectColor').value;
            if (name && !(data.subjects || []).some(s => s.name === name)) {
                if (!data.subjects) data.subjects = [];
                data.subjects.push({ name, color });
                saveDataToFirebase();
            }
            nameInput.value = '';
        });
        
        document.getElementById('addTimeSlotBtn').addEventListener('click', () => {
            const input = document.getElementById('newTimeSlot');
            const value = input.value.trim();
            if (value) {
                if (!data.timeSlots) data.timeSlots = [];
                data.timeSlots.push(value);
                saveDataToFirebase();
            }
            input.value = '';
        });

        document.getElementById('configAccordion').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const inputGroup = button.closest('.input-group');
            
            if (button.classList.contains('save-entity')) {
                const input = inputGroup.querySelector('input[type="text"]');
                const type = input.dataset.type;
                const originalValue = input.dataset.originalValue;
                const newValue = input.value.trim();
                const collection = data[type + 's'];
                const index = collection.findIndex(item => item === originalValue);

                if (newValue && originalValue !== newValue) {
                    if (collection.includes(newValue)) {
                       return showToast('Error', 'This item already exists.', 'danger');
                    }
                    collection[index] = newValue;
                    saveDataToFirebase();
                }
            }
            if (button.classList.contains('save-subject')) {
                const nameInput = inputGroup.querySelector('input[type="text"]');
                const colorInput = inputGroup.querySelector('input[type="color"]');
                const originalValue = nameInput.dataset.originalValue;
                const newValue = nameInput.value.trim();
                const newColor = colorInput.value;
                const subject = (data.subjects || []).find(s => s.name === originalValue);

                if (subject) {
                    if (newValue && originalValue !== newValue) {
                        if (data.subjects.some(s => s.name === newValue)) {
                           return showToast('Error', 'This subject name already exists.', 'danger');
                        }
                        (data.workshops || []).forEach(w => {
                            if (w.subjects && w.subjects.includes(originalValue)) {
                                w.subjects = w.subjects.map(s => s === originalValue ? newValue : s);
                            }
                        });
                        subject.name = newValue;
                    }
                    subject.color = newColor;
                    saveDataToFirebase();
                }
            }
            
            if (button.classList.contains('delete-entity')) {
                const input = inputGroup.querySelector('input[type="text"]');
                const type = input.dataset.type;
                const originalValue = input.dataset.originalValue;
                 showConfirmation(`Are you sure you want to delete "${originalValue}"?`, () => {
                    data[type + 's'] = (data[type + 's'] || []).filter(item => item !== originalValue);
                    saveDataToFirebase();
                });
            }
            if (button.classList.contains('delete-subject')) {
                const nameInput = button.closest('.input-group').querySelector('input[type="text"]');
                const originalValue = nameInput.dataset.originalValue;
                showConfirmation(`Are you sure you want to delete subject "${originalValue}"?`, () => {
                    data.subjects = (data.subjects || []).filter(s => s.name !== originalValue);
                    saveDataToFirebase();
                });
            }
        });
        
        syncWithFirebase();
    }
  </script>
</body>
</html>

